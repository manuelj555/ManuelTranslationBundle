{% extends '@ManuelTranslation/base.html.twig' %}

{% trans_default_domain "ManuelTranslationBundle" %}

{% block page_header %}{{ 'label.sync_results'|trans }}{% endblock %}

{% block page_header_right %}
    {% if conflicted_items|length == 0 %}
        <a class="btn btn-primary" href="{{ path('manuel_translation_generate_file') }}">
            {{ 'label.update_file'|trans }}
        </a>
        <a class="btn btn-default" href="{{ path('manuel_translation_list') }}">{{ 'label.back'|trans }}</a>
    {% endif %}
{% endblock %}

{% block content %}

    <table class="table table-bordered table-striped table-hover" style="width: auto">
        <tr>
            <td class="col-xs-9">{{ 'label.new_items'|trans }}</td>
            <td class="col-xs-3 text-right">{{ news|number_format(0) }}</td>
        </tr>
        <tr>
            <td>{{ 'label.updated_items'|trans }}</td>
            <td class="text-right">{{ updates|number_format(0) }}</td>
        </tr>
        <tr>
            <td>{{ 'label.conflicted_items'|trans }}</td>
            <td class="text-right">{{ conflicted_items|length|number_format(0) }}</td>
        </tr>
    </table>

    {% if conflicted_items|length > 0 %}
        <fieldset>
            <legend>{{ 'label.conflict_items'|trans }}</legend>
            
            {{ include('@ManuelTranslation/Sync/table_conflicts.html.twig') }}

        </fieldset>
    {% endif %}

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        $(".resolve-conflicts").on('click', function (e) {
            e.preventDefault();
            var $btn = $(this).button('loading');
            var $otherBtn = $btn.closest('.conflict-item').find('.resolve-conflicts').not(this).attr('disabled', true);
            var data = {
                values: $btn.data('values'),
                files: $btn.data('files'),
                hash: $btn.data('hash'),
                active: $btn.data('active'),
                new: $btn.data('new'),
                autogenerated: $btn.data('autogenerated'),
                last_changed: $btn.data('last-changed')
            };
            $.post($btn.attr('href'), data, function (res) {
                $btn.button('reset');
                $otherBtn.attr('disabled', false);
                $btn.closest('.conflict-item').remove();

                if ($('.conflict-item').size() == 0) {
                    document.location = '{{ path('manuel_translation_resolve_conflict_done') }}';
                }
            });
        });
    </script>
{% endblock %}
